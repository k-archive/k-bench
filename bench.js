// Generated by CoffeeScript 1.10.0
(function() {
  var Timer, clear, createStore, db, go, kmodel, model, populate, publicDir, store, t1, t2;

  kmodel = require('k-model');

  kmodel.Model.INITS.push(function(model) {
    return model.root.on('error', function(err) {
      return console.log(err);
    });
  });

  publicDir = __dirname + '/../../public';

  store = null;

  createStore = function(which) {
    var npm, url;
    console.log("create store in " + which);
    switch (which) {
      case 'arango':
        url = 'http://localhost:8529/kantele-app';
        npm = 'k-livedb-arango';
        break;
      case 'arango-sharding':
        url = 'http://localhost:8530/kantele-cluster';
        npm = 'k-livedb-arango';
        break;
      case 'mongo':
        url = 'mongodb://localhost:27017/kantele-app';
        npm = 'k-livedb-mongo';
        break;
      case 'mongo-sharding':
        url = 'mongodb://localhost:27011/somecl';
        npm = 'k-livedb-mongo';
        break;
    }
    return store = kmodel.createBackend({
      db: require(npm)(url, {
        safe: true
      })
    });
  };

  db = process.argv[2] || 'arango';

  if (db !== 'mongo' && db !== 'arango' && db !== 'arango-sharding' && db !== 'mongo-sharding') {
    console.log('db should be:', ['mongo', 'arango', 'arango-sharding', 'mongo-sharding']);
    process.exit();
  }

  createStore(db);

  model = store.createModel();

  Timer = (function() {
    function Timer() {}

    Timer.prototype.t = 0;

    Timer.prototype.t2 = 0;

    Timer.prototype.total = 0;

    Timer.prototype.count = 0;

    Timer.prototype.min = 999;

    Timer.prototype.max = 0;

    Timer.prototype.avg = 0;

    Timer.prototype.start = function() {
      return this.t = Date.now();
    };

    Timer.prototype.increment = function() {
      this.t2 = Date.now() - this.t;
      this.count++;
      this.total += this.t2;
      this.avg = this.total / this.count;
      this.min = Math.min(this.min, this.t2);
      return this.max = Math.max(this.max, this.t2);
    };

    Timer.prototype.end = function(s, items) {
      var ref;
      this.increment();
      return console.log(s + " " + ((items != null ? (ref = items.get()) != null ? ref.length : void 0 : void 0) || '') + "\t Average: " + (Math.round(this.avg)) + "\t Now: " + this.t2 + "\t Min: " + this.min + "\t Max: " + this.max);
    };

    return Timer;

  })();

  clear = function() {
    var items;
    items = model.query('items', {});
    return model.subscribe(items, function(err) {
      var i, item, len;
      items = items.get();
      console.log('clear', db, items != null ? items.length : void 0);
      if (items) {
        for (i = 0, len = items.length; i < len; i++) {
          item = items[i];
          model.root.del("items." + item.id);
        }
      }
      return model.whenNothingPending((function() {
        return process.exit();
      }));
    });
  };

  populate = function() {
    var i, num;
    console.log('populate 100 in', db);
    for (num = i = 1; i <= 100; num = ++i) {
      model.root.add('items', {
        name: Math.random().toString(36).substring(15),
        data: Math.random().toString(36).substring(15)
      });
    }
    return model.whenNothingPending((function() {
      return process.exit();
    }));
  };

  go = function() {
    var items;
    t1.start();
    items = model.query('items', {});
    return model.subscribe(items, function(err) {
      if (err) {
        console.log(err);
      }
      if (err) {
        return process.exit();
      } else {
        t1.end('Sub', items);
        return items.unsubscribe(function() {
          return setTimeout(go, 100);
        });
      }
    });
  };

  t1 = new Timer();

  t2 = new Timer();

  switch (process.argv[3]) {
    case 'populate':
      populate();
      break;
    case 'clear':
      clear();
      break;
    default:
      go();
  }

}).call(this);
